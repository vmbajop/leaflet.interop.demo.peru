<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mapa de pruebas de Leaflet</title>
  <link rel="stylesheet" href="libs/leaflet/leaflet.css" />
  <style>
    #map { height: 100vh; }
  </style>
</head>
<body>
  <div id="map"></div>
  <script src="libs/leaflet/leaflet.js"></script>
  <script>
    var map = L.map('map').setView([43.4917, -6.1106], 13); // Coordenadas de Pravia, Asturias
    
    cargarCapas();

    var divCoordenadas = crearDivCoordenadas();
    document.body.appendChild(divCoordenadas);

    var botonera = crearBotonera();
    document.body.appendChild(botonera);

    document.getElementById('btn-wfs').onclick = function() {
        crearDialogoCargaCapaWFS();
    };
    document.getElementById('btn-capa').onclick = function() {
        cargarCapaLocal();
    };

    map.on('click', function(click) {
      identificar(click);
    });

    map.on('mousemove', function(e) {
      divCoordenadas.innerText = `Lat: ${e.latlng.lat.toFixed(5)}, Lng: ${e.latlng.lng.toFixed(5)}`;
    });

    map.on('mouseout', function() {
      divCoordenadas.innerText = 'Lat: , Lon: ';
    });

    function cargarCapas(){
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);            
    };

    function cargarWFS(wfsURL) {
        //fetch('https://sig.asturias.es/servicios/services/ClasesAgroecologicas50000/MapServer/WFSServer?service=WFS&version=2.0.0&request=GetFeature&typeName=usos_agrarios&outputFormat=GEOJSON')
        //url a pasar: https://sig.asturias.es/servicios/services/ClasesAgroecologicas50000/MapServer/WFSServer
        wfsURL += "?service=WFS&request=GetFeature&typeName=usos_agrarios&outputFormat=GEOJSON";
        mostrarSpinner();
        fetch(wfsURL)
            .then(response => response.json())
            .then(data => {
                L.geoJSON(data, {
                    style: {
                        color: '#333333',           // Borde gris oscuro
                        weight: 1,
                        opacity: 1,                 // Sin transparencia en el borde
                        fillColor: '#FFA94D',       // Naranja suave
                        fillOpacity: 0.5            // 50% de transparencia en el interior
                    }
                }).addTo(map);
                ocultarSpinner();
            })
            .catch(err => console.error('Error cargando WFS:', err)
        );
    };

    function cargarCapaLocal(){
        fetch('capaLocal.geoJSON')
            .then(response => response.json())
            .then(data => {
                L.geoJSON(data, {
                    style: {
                        color: '#1976D2',
                        weight: 2,
                        opacity: 1,
                        fillColor: '#90CAF9',
                        fillOpacity: 0.4
                    }
                }).addTo(map);
            })
            .catch(err => console.error('Error cargando capa local:', err)
        );    
    }

    function crearDivCoordenadas() {        
        var coordDiv = document.createElement('div');
        coordDiv.style.position = 'absolute';
        coordDiv.style.bottom = '10px';
        coordDiv.style.left = '10%';
        coordDiv.style.transform = 'translateX(-50%)';
        coordDiv.style.background = 'rgba(255,255,255,0.8)';
        coordDiv.style.padding = '4px 12px';
        coordDiv.style.borderRadius = '4px';
        coordDiv.style.fontFamily = 'monospace';
        coordDiv.style.fontSize = '14px';
        coordDiv.style.zIndex = 1000;
        coordDiv.innerText = 'Lat: , Lng: ';
        return coordDiv;
    };
    
    function crearBotonera(){
        var barra = document.createElement('div');
        barra.style.position = 'absolute';
        barra.style.bottom = '30px';
        barra.style.left = '50%';
        barra.style.transform = 'translateX(-50%)';
        barra.style.background = 'rgba(255,255,255,0.6)';
        barra.style.padding = '8px 24px';
        barra.style.borderRadius = '8px';
        barra.style.display = 'flex';
        barra.style.gap = '16px';
        barra.style.boxShadow = '0 2px 8px rgba(0,0,0,0.15)';
        barra.style.zIndex = 1001;       

        barra.appendChild(crearBoton('capa'));
        barra.appendChild(crearBoton('wfs'));
        barra.appendChild(crearBoton('tool'));
        barra.appendChild(crearBoton('rest'));

        //document.body.appendChild(barra);
        return barra;
    };

    function crearBoton(texto) {
        var btn = document.createElement('button');
        // Asigna un id único a cada botón según el texto recibido
        switch (texto.toLowerCase()) {
            case 'wfs':
            btn.id = 'btn-wfs';
            btn.innerText = 'WFS';
            break;
            case 'capa':
            btn.id = 'btn-capa';
            btn.innerText = 'CAPA';
            break;
            case 'rest':
            btn.id = 'btn-rest';
            btn.innerText = 'REST';
            break;
            case 'tool':
            btn.id = 'btn-tool';
            btn.innerText = 'TOOL';
            break;
            default:
            btn.id = 'btn-otro';
            btn.innerText = texto;
        }
        btn.style.width = '64px';
        btn.style.height = '64px';
        btn.style.fontSize = '20px';
        btn.style.padding = '0';
        btn.style.border = 'none';
        btn.style.borderRadius = '8px';
        btn.style.background = '#64b5f6'; // azul más suave
        btn.style.color = '#fff';
        btn.style.cursor = 'pointer';
        btn.style.boxShadow = '0 1px 6px rgba(0,0,0,0.12)';
        btn.onmouseover = function() { btn.style.background = '#42a5f5'; };
        btn.onmouseout = function() { btn.style.background = '#64b5f6'; };
        return btn;
    };

    function crearDialogoCargaCapaWFS(){
        // Crear fondo semitransparente
        var overlay = document.createElement('div');
        overlay.style.position = 'fixed';
        overlay.style.top = 0;
        overlay.style.left = 0;
        overlay.style.width = '100vw';
        overlay.style.height = '100vh';
        overlay.style.background = 'rgba(0,0,0,0.2)';
        overlay.style.display = 'flex';
        overlay.style.alignItems = 'center';
        overlay.style.justifyContent = 'center';
        overlay.style.zIndex = 2000;

        // Crear el diálogo
        var dialog = document.createElement('div');
        dialog.style.background = '#fff';
        dialog.style.padding = '24px 20px 16px 20px';
        dialog.style.borderRadius = '8px';
        dialog.style.boxShadow = '0 2px 12px rgba(0,0,0,0.18)';
        dialog.style.minWidth = '320px';
        dialog.style.display = 'flex';
        dialog.style.flexDirection = 'column';
        dialog.style.gap = '12px';

        var label = document.createElement('label');
        label.innerText = 'URL del servicio WFS:';
        label.style.marginBottom = '4px';

        var input = document.createElement('input');
        input.type = 'text';
        input.style.width = '100%';
        input.style.padding = '6px 8px';
        input.style.fontSize = '15px';
        input.style.border = '1px solid #bbb';
        input.style.borderRadius = '4px';

        var btns = document.createElement('div');
        btns.style.display = 'flex';
        btns.style.justifyContent = 'flex-end';
        btns.style.gap = '12px';

        var btnCancelar = document.createElement('button');
        btnCancelar.innerText = 'Cancelar';
        btnCancelar.style.padding = '6px 16px';
        btnCancelar.style.border = 'none';
        btnCancelar.style.borderRadius = '4px';
        btnCancelar.style.background = '#eee';
        btnCancelar.style.cursor = 'pointer';

        var btnAceptar = document.createElement('button');
        btnAceptar.innerText = 'Aceptar';
        btnAceptar.style.padding = '6px 16px';
        btnAceptar.style.border = 'none';
        btnAceptar.style.borderRadius = '4px';
        btnAceptar.style.background = '#1976D2';
        btnAceptar.style.color = '#fff';
        btnAceptar.style.cursor = 'pointer';

        btnCancelar.onclick = function() {
            document.body.removeChild(overlay);
        };

        btnAceptar.onclick = function() {
            var url = input.value.trim();
            if (url) {
            cargarWFS(url);
            document.body.removeChild(overlay);
            } else {
            input.style.border = '1.5px solid #e53935';
            input.focus();
            }
        };

        btns.appendChild(btnCancelar);
        btns.appendChild(btnAceptar);

        dialog.appendChild(label);
        dialog.appendChild(input);
        dialog.appendChild(btns);

        overlay.appendChild(dialog);
        document.body.appendChild(overlay);

        input.focus();
    };

    function mostrarSpinner() {
        let spinner = document.getElementById('spinner-cargando');
        if (!spinner) {
            spinner = document.createElement('div');
            spinner.id = 'spinner-cargando';
            spinner.style.position = 'fixed';
            spinner.style.top = '0';
            spinner.style.left = '0';
            spinner.style.width = '100vw';
            spinner.style.height = '100vh';
            spinner.style.background = 'rgba(255,255,255,0.1)';
            spinner.style.display = 'flex';
            spinner.style.alignItems = 'center';
            spinner.style.justifyContent = 'center';
            spinner.style.zIndex = 3000;

            let spin = document.createElement('div');
            spin.style.width = '32px';
            spin.style.height = '32px';
            spin.style.border = '4px solid #eee';
            spin.style.borderTop = '4px solid #1976D2';
            spin.style.borderRadius = '50%';
            spin.style.animation = 'spin 1s linear infinite';
            spinner.appendChild(spin);

            // Agrega la animación CSS
            let style = document.createElement('style');
            style.innerHTML = `
            @keyframes spin {
                0% { transform: rotate(0deg);}
                100% { transform: rotate(360deg);}
            }`;
            document.head.appendChild(style);

            document.body.appendChild(spinner);
        } else {
            spinner.style.display = 'flex';
        }
    };

    function ocultarSpinner() {

        let spinner = document.getElementById('spinner-cargando');
        if (spinner) spinner.style.display = 'none';
    }

    function identificar(e){        
        let encontrados = [];
        map.eachLayer(function(layer) {
            if (layer instanceof L.GeoJSON) {
            layer.eachLayer(function(fLayer) {
                // Para polígonos y líneas
                if (fLayer.feature && fLayer.getBounds && fLayer.getBounds().contains(e.latlng)) {
                encontrados.push(fLayer);
                }
                // Para puntos (marcadores)
                else if (fLayer.feature && fLayer.getLatLng && fLayer.getLatLng().distanceTo(e.latlng) < 10) {
                encontrados.push(fLayer);
                }
            });
            }
        });

        if (encontrados.length > 0) {
            let contenido = encontrados.map((f, i) =>
            `<b>Entidad ${i + 1}</b><br>` +
            Object.entries(f.feature.properties || {})
                .map(([k, v]) => `<b>${k}:</b> ${v}`)
                .join('<br>')
            ).join('<hr style="margin:6px 0;">');
            // Envuelve el contenido en un div con scroll lateral y altura máxima
            let popupContent = `<div style="max-height:220px; max-width:340px; overflow:auto;">${contenido}</div>`;
            L.popup()
            .setLatLng(e.latlng)
            .setContent(popupContent)
            .openOn(map);
        }
    }
  </script>
</body>
</html>